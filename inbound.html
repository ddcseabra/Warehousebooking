<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Inbound booking</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
 
  <style>
    :root {
      --primary-color: #4A55A2;
      --light-gray: #f0f2f5;
      --dark-gray: #555;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background-image: url('https://images.unsplash.com/photo-1586528116311-06924151d18a?q=80&w=2070&auto=format&fit=crop');
      background-size: cover;
      background-position: center;
      min-height: 100vh;
      color: var(--dark-gray);
    }

    .header-container {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      background: var(--primary-color);
      height: 10vh;
      width: 100%;
    }

    .header-img {
      height: 100%;
    }

    .header-list {
      display: flex;
      list-style: none;
      gap: 20px;
      height: 100%;
      align-items: center;

      a {
        text-decoration: none;
        color: #fff;
      }
    }

    .header-list li.active a {
      border-bottom: 2px solid #fff;
      font-weight: 600;
    }

    .main-container {
      max-width: 1000px;
      margin: auto;
    }

    h1 {
      padding: 20px;
    }

    fieldset {
      display: flex;
      flex-direction: column;
      border: none;
      padding: 20px;
      gap: 10px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      margin-bottom: 20px;

    }



    select,
    input,
    textarea {
      padding: 10px;
      font-size: 0.8em;

    }

    select {
      max-width: 100%;
      width: 100%;
    }

    select option {
      font-size: 0.8em;
      white-space: normal;
      word-wrap: break-word;

    }

    input {
      width: 100%;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 20px;
      padding: 0 20px 20px;
    }

    input[type="date"],
    input[type="time"] {
      cursor: pointer;
    }



    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }

    th,
    td {
      padding: 10px;
      text-align: left;
      border: 1px solid #ddd;
    }

    th {
      background: var(--primary-color);
      color: white;
      font-size: 0.7em;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
    button {
      font-family: 'Sarabun', sans-serif;
      font-weight: 500;
      border: none;
      border-radius: 5px;
      padding: 6px 14px;
      width: 80px;
      cursor: pointer;
      transition: all 0.25s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    
    #add-button {
      background: #999;
      color: #fff;
      font-size: 0.8em;
      padding: 6px 14px;
      border-radius: 6px;
      gap: 6px;
      transition: all 0.2s ease;
      margin-top: 10px;
    }

    #add-button:hover {
      background: #777;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }



    /* ‡∏õ‡∏∏‡πà‡∏° Save */
    #save-button {
      background: #63A89A;
      color: #fff;
    }

    #save-button:hover {
      background: #4e8c80;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    }

    /* ‡∏õ‡∏∏‡πà‡∏° Cancel */
    #cancel-button {
      background: #A31621;
      color: #fff;
    }

    #cancel-button:hover {
      background: #86121b;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    }
  </style>
</head>

<body>

  <header>
    <div class="header-container">

      <a href="menu.html"><img src="/img/home.png" class="header-img" alt=""></a>
      <nav>
        <ul class="header-list">
          <li class="active"><a href="#">Inbound</a></li>
          <li><a href="outbound.html">Outbound</a></li>
          <li><a href="#">Stock</a></li>
        </ul>
      </nav>
      <a href="#"><img src="/img/user.png" class="header-img" alt=""></a>
    </div>
  </header>

  <main>
    <section class="booking-section">
      <div class="main-container">
        <h1>Create New Inbound Booking</h1>

        <!-- Service -->
        <fieldset>
          <label for="service">Select Service üöö</label>
          <select id="service" required>
            <option value="general-storage" selected>General Storage</option>
            <option value="cold-storage">Cold Storage</option>
          </select>

          <label for="sub-service">Select Sub-Service üöö</label>
          <select id="sub-service" required>
            <option value="">-- Select Sub-Service --</option>
          </select>
        </fieldset>

        <!-- Date Time -->
        <fieldset>
          <label for="booking-date">Date üìÖ</label>
          <input type="date" id="booking-date" required>

          <label for="booking-time">Time üïí</label>
          <input type="time" id="booking-time" required>
        </fieldset>

        <!-- Product Select -->
        <fieldset>
          <label for="product">Select Product üì¶</label>
          <select id="product" required>
            <option value="">-- Select Product --</option>
          </select>

          <label for="quantity">Quantity üî¢</label>
          <input type="number" id="quantity" min="1" required>

          <label for="remark">Remark üí¨</label>
          <textarea id="remark" rows="2" placeholder="Enter remark ..." style="resize: none;"></textarea>

          <button type="button" id="add-button">+ Add</button>
        </fieldset>

        <!-- Gallery -->
        <fieldset>
          <h3>Current Items</h3>
          <table id="items-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Qty</th>
                <th>Remark</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </fieldset>

        <div class="form-actions">
          <button type="button" id="cancel-button">Cancel</button>
          <button type="button" id="save-button">Save</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbxzyUwsTxDll7QVH0eFwcA_DufRJV48eh-BtPISn3A5QkiOaeMnsMdjHzXgm4HawpQn/exec";

    const subServiceOptions = {
      "general-storage": [
        { value: "gs-storage-area", text: "Storage Area 5,000 SQ.M" },
        { value: "gs-load-unload", text: "Load & Unload Container 20' & 40'" },
        { value: "gs-repack-lashing", text: "Repack Wrap & Lashing product on pallet" },
        { value: "gs-distribution-dc", text: "Distribution on DC and Drop off point" },
        { value: "gs-wooden-fumigate", text: "Wooden case with fumigate and certificate" }
      ],
      "cold-storage": [
        { value: "cs-control-room", text: "Control room 25 degree" },
        { value: "cs-chill-room", text: "Chill room 2-6 degree" },
        { value: "cs-frozen-room", text: "Frozen room -18 degree" },
        { value: "cs-distribution-temp", text: "Distribution all temperature controlled to all destination" },
        { value: "cs-prime-location", text: "Prime location" }
      ]
    };

    const serviceSelect = document.getElementById("service");
    const subServiceSelect = document.getElementById("sub-service");
    const bookingDate = document.getElementById("booking-date");
    const bookingTime = document.getElementById("booking-time");
    const productSelect = document.getElementById("product");
    const quantityInput = document.getElementById("quantity");
    const remark = document.getElementById("remark");
    const addButton = document.getElementById("add-button");
    const saveButton = document.getElementById("save-button");
    const cancelButton = document.getElementById("cancel-button");
    const itemsTableBody = document.querySelector("#items-table tbody");

    let bookingItems = [];

    // Update sub-service options
    function updateSubServices() {
      const selected = serviceSelect.value;
      subServiceSelect.innerHTML = '<option value="">-- Select Sub-Service --</option>';
      subServiceOptions[selected].forEach(opt => {
        const option = document.createElement("option");
        option.value = opt.value;
        option.textContent = opt.text;
        subServiceSelect.appendChild(option);
      });
    }

    serviceSelect.addEventListener("change", updateSubServices);
    updateSubServices();

    // Load product from stock.json
    async function loadProducts() {
      const user = JSON.parse(localStorage.getItem("user")); // ‚úÖ ‡∏î‡∏∂‡∏á user ‡∏à‡∏≤‡∏Å localStorage
      if (!user) {
        alert("Please login first!");
        window.location.href = "index.html";
        return;
      }

      const res = await fetch("data/stocks.json");
      const stockData = await res.json(); // stockData.stocks ‡πÄ‡∏õ‡πá‡∏ô array
      const customerProducts = stockData.stocks.filter(p => p.customerid === user.customerid);

      customerProducts.forEach(p => {
        const option = document.createElement("option");
        option.value = p.productCode;  // ‡πÉ‡∏ä‡πâ productCode ‡πÅ‡∏ó‡∏ô productid
        option.textContent = `${p.productName} (Stock: ${p.quantity})`; // ‡πÉ‡∏ä‡πâ productName ‡πÅ‡∏ó‡∏ô productname
        productSelect.appendChild(option);
      });

    }

    // Add product to bookingItems
    addButton.addEventListener("click", () => {
      const productId = productSelect.value;
      const productName = productSelect.selectedOptions[0]?.text;
      const qty = parseInt(quantityInput.value);
      const remarkValue = remark.value;

      if (!productId || !qty || qty <= 0) {
        alert("Please select product and enter valid quantity!");
        return;
      }

      bookingItems.push({ productId, productName, qty, remark: remarkValue });
      renderTable();

      productSelect.value = "";
      quantityInput.value = "";
      remark.value = "";
    });

    // Render table
    function renderTable() {
      itemsTableBody.innerHTML = "";
      bookingItems.forEach((item, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.productName}</td>
          <td>${item.qty}</td>
          <td>${item.remark}</td>
          <td><button class="remove-btn" onclick="removeItem(${index})">Remove</button></td>
        `;
        itemsTableBody.appendChild(tr);
      });
    }

    window.removeItem = (index) => {
      bookingItems.splice(index, 1);
      renderTable();
    };

    // Cancel
    cancelButton.addEventListener("click", () => {
      if (confirm("Are you sure you want to cancel? All data will be cleared.")) {
        serviceSelect.value = "general-storage";
        bookingDate.value = "";
        bookingTime.value = "";
        bookingItems = [];
        renderTable();
        updateSubServices();
      }
    });

    // =================== ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å BookingItems ===================

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î booking.json ‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç bookingid ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
async function getLatestBookingId() {
  const res = await fetch("https://ddcseabra.github.io/Warehousebooking/data/booking.json");
  const bookings = await res.json();
  const latestId = bookings.reduce((max, b) => {
    const num = parseInt(b.bookingid.slice(1)); // ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ B
    return num > max ? num : max;
  }, 0);
  return { bookings, latestId };
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON (‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ô GitHub Pages)
function downloadJSON(data, filename) {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

// ‡∏ï‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Save ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
saveButton.addEventListener("click", async () => {
  if (bookingItems.length === 0) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
    return;
  }

  const user = JSON.parse(localStorage.getItem("user"));
  const service = serviceSelect.selectedOptions[0].text;
  const subService = subServiceSelect.selectedOptions[0].text;
  const date = bookingDate.value;
  const time = bookingTime.value;

  if (!service || !subService || !date || !time) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á");
    return;
  }

  const { bookings, latestId } = await getLatestBookingId();
  let newIdCounter = latestId;

  const newBookings = bookingItems.map(item => {
    newIdCounter++;
    return {
      bookingid: "B" + newIdCounter.toString().padStart(3, "0"),
      customername: user.customername,
      type: "inbound",
      service,
      subservice: subService,
      bookingdate: date,
      bookingtime: time,
      remark: item.remark,
      productname: item.productName,
      quantity: item.qty
    };
  });

  const updatedBookings = [...bookings, ...newBookings];

  downloadJSON(updatedBookings, "booking.json");
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå booking.json ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");

  // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
  bookingItems = [];
  renderTable();
  bookingDate.value = "";
  bookingTime.value = "";
  serviceSelect.value = "general-storage";
  updateSubServices();
});

  </script>


</body>

</html>

